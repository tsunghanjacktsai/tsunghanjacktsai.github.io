<!DOCTYPE HTML>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
	<link rel="bookmark" type="image/x-icon" href="/img/me.jpg">
	<link rel="shortcut icon" href="/img/me.jpg">
	<script data-ad-client="ca-pub-3134773914228719" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	
			    <title>
    Jack's Blog
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/css/mic_main.css">
    <link rel="stylesheet" href="/css/dropdownMenu.css">
    <meta name="keywords" content="java, computer science, programming">
    <meta data-react-helmet="true" property="og:image" content="https://www.jacktsaitech.com/images/Cover Page.png">
    <meta data-react-helmet="true" property="og:type" content="website">
    <meta data-react-helmet="true" property="og:url" content="https://www.jacktsaitech.com">
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/highlight.js"></script>
	
<link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_okaidia.css">
<link rel="stylesheet" href="/css/typo.css">
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <!-- <header id="header">
    <a href="/" class="logo">JACK</a>
</header> -->
        <header id="post-header"></header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
            <ul class="menu links">
			<!-- Homepage  主页  --> 
			<li>
	            <a href="/" rel="nofollow">Home</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            	<a href="#s1">Category</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/Algorithms/">Algorithms</a></li><li><a class="category-link" href="/categories/Concurrency/">Concurrency</a></li><li><a class="category-link" href="/categories/IoTDB/">IoTDB</a></li><li><a class="category-link" href="/categories/LeetCode/">LeetCode</a></li><li><a class="category-link" href="/categories/Operating-System/">Operating System</a>
	                    </li></ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/tag/" title="Tag">
		                Tag
		            </a>
		        </li>
		        
		        <li>
		            <a href="/about/" title="About">
		                About
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
					<li class="translate-style">
						<a id="translateButtonObject" href="javascript:translatePage();">繁&#8644;简</a>
					</li>
                    
                    <li>
                        <a title="github" href="https://github.com/jack870131" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="linkedin" href="https://www.linkedin.com/in/tsung-han-jack-tsai-62696314b" target="_blank" rel="noopener">
                            <i class="icon fa fa-linkedin"></i>
                        </a>
                    </li>
                    
			</ul>
			<script type="text/javascript" src="/js/tw_cn.js"></script>
			<script type="text/javascript">
				var defaultEncoding = 2; //網站編寫字體是否繁體，1-繁體，2-簡體
				var translateDelay = 0; //延遲時間,若不在前, 要設定延遲翻譯時間, 如100表示100ms,默認為0
				var cookieDomain = "https://jack870131.github.io/"; //Cookie地址, 一定要設定, 通常為你的網址
				var translateButtonId = "translateLink"; //默認互換id
				translateInitilization();
			</script>
</nav>

        <div id="main">
            <div class="post_page_title_img"></div>
            <!-- Post -->
            <div class="typo">
                <h1><span id="java-併发容器和框架">Java 併发容器和框架</span></h1><p>本篇博客主要是纪录对&lt;&lt;Java并发编程的艺术&gt;&gt;的学习心得以及一些知识点的重新整理，因此文章中会有许多引用自该书的文字。同时也借鑑其他相关的技术博客，以完善整个知识框架。</p>
<h2><span id="concurrenthashmap">ConcurrentHashMap</span></h2><p>ConcurrentHashMap视线安全且高效的HashMap，接下来将介绍该容器是如何保证线程安全的。</p>
<h3><span id="为甚麽使用concurrenthashmap">为甚麽使用ConcurrentHashMap</span></h3><p>在併发编程中使用HashMap可能导致程序死循环。而使用线程安全的HashTable效率又非常低下，基于以上两个原因，便有了ConcurrentHashMap的登场机会。</p>
<ol>
<li><p>线程不安全的HashMap</p>
<p>在多线程环境下，使用HashMap进行put操作会引起死循环，导致CPU利用率接近100%，所以在併发情况下不能使用HashMap。例如，执行以下代码会引起死循环。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> Hash<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"ftf"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"ftf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>HashMap在併发执行put操作时会引起死循环，是因为多线程会导致HashMap的Entry链表形成数据结构，一旦形成环形数据结构，Entru的next节点永远不为空，就会产生死循环获取Entry。</p>
</li>
<li><p>效率低下的HashTable</p>
<p>HashTable容器使用synchronized来保证线程安全，但在线程竞争激烈的情况下HashTable的效率非常低下。因为当一个线程访问HashTable的同步方法，其他线程也访问HashTable的同步方法时，会进入阻塞或轮询状态。如线程1使用put进行元素添加，线程2不但不能使用put方法添加元素，也不能使用get方法来获取元素，所以竞争越激烈效率越低。</p>
</li>
<li><p>ConcurrentHashMap的锁分段技术可有效提升併发访问率</p>
<p>HashTable容器在竞争激烈的併发环境下表现出效率低下的原因是所有访问HashTable的线程都必须竞争同一把锁，假如容器裡有多把锁，每一把锁用于锁容器其中一部份数据，那麽当多线程访问容器裡不同数据段的数据时，线程间就不会存在锁竞争，从而可以有效提高併发访问效率，这就是ConcurrentHashMap所使用的锁分段技术。首先将数据分成一段一段的存储，然后给每一段数据赔一把锁，当一个线程占用锁访问其中一个段数据的时候，其他段的数据也能被其他线程访问。</p>
</li>
</ol>
<h3><span id="concurrenthashmap的结构">ConcurrentHashMap的结构</span></h3><p>通过ConcurrentHashMap的类图来分析ConcurrentHashMap的结构，如下图所示:</p>
<img src="https://i.imgur.com/r0v3fEY.jpg" alt="ConcurrentHashMap类图" style="zoom: 33%;">

<p>ConcurrentHashMap是由Segment数组结构和HashEntry数组结构组成。Segment是一种可重入锁(ReentrantLock)，在ConcurrentHashMap裡面扮演锁的角色; HashEntry则用于存储键值对数据。一个ConcurrentHashMap裡包含一个Segment数组，每个HashEntry是一个链表结构的元素，每个Segment守护着一个HashEntry数组裡的元素，当对HashEntry数组的数据进行修改时，必须首先获得与他对应的Segment锁。以下是ConcurrentHashMap的结构图:</p>
<img src="https://i.imgur.com/PPpVMLv.jpg" alt="ConcurrentHashMap结构图" style="zoom:33%;">

<h3><span id="源码分析">源码分析</span></h3><p>详见之后的源码分析。</p>
<h2><span id="concurrentlinkedqueue">ConcurrentLinkedQueue</span></h2><p>在併发编成中，有时候需要使用现成安全的队列。如果要实现一个现成安全的队列有两种方式: 一种是使用阻塞算法，另一种是使用非阻塞算法。使用阻塞算法的队列可以用一个锁(入队和出队使用同一把所)或两个锁(入队和出队用不同的锁)等方式来实现。非阻塞的方式则可以使用循环CAS的方式来实现。ConcurrentLinkedQueue就是以非阻塞的方式实现的线程安全队列。</p>
<p>ConcurrentLinkedQueue是一个基于链接节点的无界线程安全队列，他採用先进先出的规则对节点进行排序，当我们添加一个元素的时候，他会添加到对列的尾部; 当我们获取一个元素时，它会返回队列头部的元素。它採用了”wait-free”算法(即CAS)来实现。</p>
<h3><span id="concurrentlinkedqueue的结构">ConcurrentLinkedQueue的结构</span></h3><img src="https://i.imgur.com/aK3b5DR.jpg" alt="ConcurrentLinkedQueue类图" style="zoom:33%;">

<p>ConcurrentLinkedQueue由head节点和tail节点组成，没个节点(Node)由节点元素(item)和指向下一个节点(next)的饮用组成，节点与节点之间就是通过这个next关联起来，从而组成一张链表结构的对列。默认情况下head节点存储的元素为空，tail节点等于head节点。</p>
<h3><span id="源码分析">源码分析</span></h3><p>详见之后的源码分析。</p>
<h2><span id="java中的阻塞队列">Java中的阻塞队列</span></h2><p>本节将介绍Java中的阻塞队列</p>
<h3><span id="甚麽是阻塞队列">甚麽是阻塞队列</span></h3><p>阻塞队列(BlockingQueue)是一个支持两个富家操作的队列。这两个富家的操作支持阻塞的插入和移除方法。</p>
<ol>
<li>支持阻塞的插入方法: 意思是当队列满十，队列会阻塞插入元素的线程，直到队列不满。</li>
<li>支持阻塞的移除方法: 意思是在队列为空时，获取元素的线程会等待队列变为非空。</li>
</ol>
<p>阻塞队列成用于生产者和消费者的场景，生产者是向队列李添加元素的线程，消费者是从队列裡取元素的线程。阻塞队列就是生产者用来存放元素、消费者用来获取元素的容器。</p>
<p>在阻塞队列不可用时，这两个富家操作提供了4种处理方式，如下表所示:</p>
<table>
<thead>
<tr>
<th align="center">方法/处理方式</th>
<th align="center">抛出异常</th>
<th align="center">返回特殊值</th>
<th align="center">一直阻塞</th>
<th align="center">超时退出</th>
</tr>
</thead>
<tbody><tr>
<td align="center">插入方法</td>
<td align="center">add(e)</td>
<td align="center">offer(e)</td>
<td align="center">put(e)</td>
<td align="center">offer(e, time, unit)</td>
</tr>
<tr>
<td align="center">移除方法</td>
<td align="center">remove()</td>
<td align="center">poll()</td>
<td align="center">take()</td>
<td align="center">poll(time, unit)</td>
</tr>
<tr>
<td align="center">检查方法</td>
<td align="center">element()</td>
<td align="center">peek()</td>
<td align="center">不可用</td>
<td align="center">不可用</td>
</tr>
</tbody></table>
<ul>
<li>抛出异常: 当队列满时，如果再往裡面插入元素，会抛出IllegalStateException(“Queue full”)异常。当队列空时，从队列或取元素会抛出NoSuchElementException异常。</li>
<li>返回特殊值: 当网队列插入元素时，会返回元素是否插入成功，成功返回true。如果是移除方法，则是从队列裡取出一个元素，如果没有则返回null。</li>
<li>一直阻塞: 当阻塞队列满时，如果生产者线程往队列裡put元素，队列会一直阻塞生产者线程，直到队列可用或者响应中断退出。当队列为空时，如果消费者线程从队列裡take元素，队列会阻塞住消费者线程，直到队列不为空。</li>
<li>超时退出: 当阻塞队列满时，如果生产者线程往队列裡插入元素，队列会阻塞生产者线程段时间，如果超过了指定时间，生产者线程就会退出。</li>
</ul>
<h3><span id="java裡的阻塞队列">Java裡的阻塞队列</span></h3><p>JDK 7提供了以下7种阻塞队列:</p>
<ul>
<li>ArrayBlockingQueue: 一个由数组结构组成的有界阻塞队列。</li>
<li>LinkedBlockingQueue: 一个由链表结构组成的有界阻塞队列。</li>
<li>PriorityBlockingQueue: 一个使用优先级排序的无界阻塞队列。</li>
<li>DelayQueue: 一个使用优先级队列实现的无界阻塞队列。</li>
<li>SynchronousQueue: 一个不存储元素的阻塞队列。</li>
<li>LinkedTransferQueue: 一个由链表结构组成的无界阻塞队列。</li>
<li>LinkedBlockingDeque: 一个由链表结构组成的双向阻塞队列。</li>
</ul>
<h3><span id="源码分析">源码分析</span></h3><p>详见之后的源码分析。</p>

            </div>
        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li><br>
                Tsung Han Tsai © 2018 - 2021 • All rights reserved
            </ul>
        </div>
    </div>
</body>

 	
</html>
